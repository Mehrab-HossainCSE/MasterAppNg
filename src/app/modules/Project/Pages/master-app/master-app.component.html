<div class="card shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="card-title">User List</h3>
    <div class="card-toolbar">
      <button
        class="btn btn-sm btn-primary"
        (click)="createOrEditModalPopUp(userModal)"
      >
        <i class="bi bi-plus-circle"></i> Add User
      </button>
    </div>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table align-middle table-row-dashed table-hover mb-0">
        <thead>
          <tr class="fw-bold">
            <th class="min-w-100px">ID</th>
            <th class="min-w-100px">User ID</th>
            <th class="min-w-150px">User Name</th>
            <th class="min-w-120px text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let user of allUsers; let i = index"
            (dblclick)="createOrEditModalPopUp(userModal, user)"
          >
            <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
            <td>{{ user.userID }}</td>
            <td>{{ user.userName }}</td>

            <td class="text-end">
              <div class="dropdown">
                <button
                  class="btn btn-sm btn-light-primary btn-active-light-primary"
                  type="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  (click)="toggleDropdown(i, $event)"
                >
                  Actions
                  <i class="bi bi-chevron-down ms-2"></i>
                </button>

                <ul
                  class="dropdown-menu menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4 end-0"
                  [ngClass]="{
                    show: isOpenAction === i,
                    dropup: i + 1 > allUsers.length - 2
                  }"
                >
                  <li>
                    <a
                      class="dropdown-item menu-link px-3"
                      (click)="createOrEditModalPopUp(userModal, user)"
                    >
                      <i class="bi bi-pencil-square me-2"></i>
                      Edit UserInfo
                    </a>
                  </li>
                  <li>
                    <!-- <a
                      
                      class="dropdown-item menu-link px-3"
                      (click)="onAddProject(projectModal, user.userID)"
                    >
                      <i class="bi bi-folder-plus me-2"></i>
                      Add Project
                    </a> -->
                  </li>
                </ul>
              </div>
            </td>
          </tr>
          <tr *ngIf="!allUsers || allUsers.length === 0">
            <td colspan="4" class="text-center text-muted py-5">
              No users found.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Multi-Step Modal Template -->
<ng-template #userModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title d-flex align-items-center">
      <i class="ki-duotone ki-user fs-2 me-2"></i>
      {{ getStepTitle() }}
    </h5>
    <button
      type="button"
      class="btn-close"
      (click)="modal.dismiss('close')"
    ></button>
  </div>

  <div class="modal-body p-6">
    <!-- Top Horizontal Stepper -->
    <div
      class="stepper stepper-pills stepper-column d-flex flex-column"
      id="kt_create_account_stepper"
    >
      <!-- Horizontal Stepper Nav -->
      <div
        class="stepper-nav d-flex flex-row align-items-center justify-content-between mb-10 px-10"
      >
        <!-- Step 1 -->
        <div
          class="stepper-item d-flex align-items-center"
          [class.current]="currentStep === 1"
          [class.completed]="currentStep > 1"
          (click)="goToStep(1)"
          [style.cursor]="'pointer'"
        >
          <!-- Step Icon -->
          <div
            class="stepper-icon w-40px h-40px d-flex align-items-center justify-content-center rounded-circle"
            [ngClass]="{
              'bg-primary text-white': currentStep === 1,
              'bg-success text-white': currentStep > 1,
              'bg-light text-gray-600': currentStep < 1
            }"
          >
            <span class="fw-bold">{{ currentStep > 1 ? "✓" : "1" }}</span>
          </div>

          <!-- Step Label -->
          <div class="stepper-label ms-3 text-start">
            <h6
              class="fw-bold mb-0"
              [ngClass]="{ 'text-primary': currentStep === 1 }"
            >
              User Information
            </h6>
          </div>
        </div>

        <!-- Stepper line -->
        <div class="stepper-line flex-grow-1 h-2px bg-gray-300 mx-6"></div>

        <!-- Step 2 -->
        <div
          class="stepper-item d-flex align-items-center"
          [class.current]="currentStep === 2"
          [class.completed]="currentStep > 2"
          (click)="isUserFormValid() && goToStep(2)"
          [style.cursor]="isUserFormValid() ? 'pointer' : 'not-allowed'"
        >
          <!-- Step Icon -->
          <div
            class="stepper-icon w-40px h-40px d-flex align-items-center justify-content-center rounded-circle"
            [ngClass]="{
              'bg-primary text-white': currentStep === 2,
              'bg-success text-white': currentStep > 2,
              'bg-light text-gray-600': currentStep < 2
            }"
          >
            <span class="fw-bold">{{ currentStep > 2 ? "✓" : "2" }}</span>
          </div>

          <!-- Step Label -->
          <div class="stepper-label ms-3 text-start">
            <h6
              class="fw-bold mb-0"
              [ngClass]="{ 'text-primary': currentStep === 2 }"
            >
              Assign projects
            </h6>
          </div>
        </div>
      </div>

      <!-- Step Content -->
      <div class="stepper-content">
        <form [formGroup]="userForm" novalidate="novalidate">
          <!-- Step 1: User Information -->
          <div class="current" *ngIf="currentStep === 1">
            <!-- User Info Grid - Compact Layout -->
            <div class="row g-4">
              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold required fs-7"
                    >User Name</label
                  >
                  <input
                    type="text"
                    class="form-control form-control-sm form-control-solid"
                    formControlName="userName"
                    placeholder="Enter user name"
                  />
                  <div
                    class="invalid-feedback"
                    *ngIf="
                      userForm.get('userName')?.invalid &&
                      userForm.get('userName')?.touched
                    "
                  >
                    User name is required
                  </div>
                </div>
              </div>

              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold required fs-7"
                    >Password</label
                  >
                  <input
                    type="password"
                    class="form-control form-control-sm form-control-solid"
                    formControlName="password"
                    placeholder="Enter password"
                  />
                  <div
                    class="invalid-feedback"
                    *ngIf="
                      userForm.get('password')?.invalid &&
                      userForm.get('password')?.touched
                    "
                  >
                    Password is required
                  </div>
                </div>
              </div>

              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7">Full Name</label>
                  <input
                    type="text"
                    class="form-control form-control-sm form-control-solid"
                    formControlName="fullName"
                    placeholder="Enter full name"
                  />
                </div>
              </div>

              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold required fs-7">Email</label>
                  <input
                    type="email"
                    class="form-control form-control-sm form-control-solid"
                    formControlName="email"
                    placeholder="Enter email address"
                  />
                  <div
                    class="invalid-feedback"
                    *ngIf="
                      userForm.get('email')?.invalid &&
                      userForm.get('email')?.touched
                    "
                  >
                    Valid email is required
                  </div>
                </div>
              </div>

             
              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7"
                    >Designation For VatPro</label
                  >
                  <select
                    class="form-select form-select-sm form-select-solid"
                    formControlName="designationID"
                  >
                    <option value="" disabled selected>
                      Select designation
                    </option>
                    <option
                      *ngFor="let d of allDesignations"
                      [value]="d.DES_ID"
                    >
                      {{ d.DES_TITLE }}
                    </option>
                  </select>
                </div>
              </div>

              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7">Mobile No</label>
                  <input
                    type="text"
                    class="form-control form-control-sm form-control-solid"
                    formControlName="mobileNo"
                    placeholder="Enter mobile number"
                  />
                </div>
              </div>

              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7"
                    >RoleName Vat pro</label
                  >
                  <select
                    class="form-select form-select-sm form-select-solid"
                    formControlName="RoleId"
                  >
                    <option value="" disabled selected>Select role</option>
                    <option *ngFor="let d of allRoleVatPro" [value]="d.RoleId">
                      {{ d.RoleName }}
                    </option>
                  </select>
                </div>
              </div>

              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7">Company Code</label>
                  <input
                    type="text"
                    class="form-control form-control-sm form-control-solid"
                    formControlName="companyCode"
                    placeholder="Enter company code"
                  />
                </div>
              </div>
            
             
           
              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7">NID</label>
                  <input
                    type="text"
                    class="form-control form-control-sm form-control-solid"
                    formControlName="NID"
                    placeholder="Enter NID"
                  />
                </div>
              </div>

              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7">IMEI Billing</label>
                  <input
                    type="text"
                    class="form-control form-control-sm form-control-solid"
                    formControlName="IMEI"
                    placeholder="Enter IMEI"
                  />
                </div>
              </div>

              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7"
                    >Branch For VatPro</label
                  >
                  <select
                    class="form-select form-select-sm form-select-solid"
                    formControlName="branch"
                  >
                    <option value="" disabled selected>Select branch</option>
                    <option *ngFor="let b of branchList" [value]="b.BranchID">
                      {{ b.BranchName }}
                    </option>
                  </select>
                </div>
              </div>

              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7"
                    >Is MobileAppUser in Billing</label
                  >
                  <div
                    class="form-check form-switch form-check-custom form-check-solid mt-2"
                  >
                    <input
                      class="form-check-input"
                      type="checkbox"
                      formControlName="IsMobileAppUser"
                      id="kt_modal_add_customer_billing"
                    />
                    <label
                      class="form-check-label fw-semibold text-gray-600 fs-7 ms-2"
                      for="kt_modal_add_customer_billing"
                    >
                      Mark as MobileAppUser
                    </label>
                  </div>
                </div>
              </div>

              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7">Status</label>
                  <div
                    class="form-check form-switch form-check-custom form-check-solid mt-2"
                  >
                    <input
                      class="form-check-input"
                      type="checkbox"
                      formControlName="inActive"
                      id="kt_modal_add_customer_billing"
                    />
                    <label
                      class="form-check-label fw-semibold text-gray-600 fs-7 ms-2"
                      for="kt_modal_add_customer_billing"
                    >
                      Mark as active
                    </label>
                  </div>
                </div>
              </div>

              <div class="col-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7"
                    >Expiry Date Billing</label
                  >
                  <input
                    type="date"
                    class="form-control form-control-sm form-control-solid"
                    formControlName="expairsOn"
                    placeholder="Select date"
                  />
                </div>
              </div>

            

              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7"
                    >Company ID for Sorol</label
                  >

                  <ng-select
                    class="form-control form-control-sm form-control-solid"
                    [items]="loadCompnayListSorol"
                    bindLabel="cFullName"
                    bindValue="cShortName"
                    [multiple]="true"
                    [closeOnSelect]="false"
                    [clearable]="false"
                    placeholder="Select Company(s)"
                    formControlName="companyIdSorol"
                  >
                    <!-- selected badges -->
                    <ng-template ng-label-tmp let-item="item">
                      <span class="badge bg-primary me-1">
                        {{ item.cFullName }}
                      </span>
                    </ng-template>

                    <!-- dropdown option template with checkbox -->
                    <ng-template
                      ng-option-tmp
                      let-item="item"
                      let-index="index"
                    >
                      <input
                        type="checkbox"
                        [checked]="
                          userForm
                            .get('companyIdSorol')
                            ?.value?.includes(item.cShortName)
                        "
                        class="me-2"
                      />
                      {{ item.cFullName }}
                    </ng-template>
                  </ng-select>
                </div>
              </div>

              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7"
                    >RoleName Billing</label
                  >
                  <select
                    class="form-select form-select-sm form-select-solid"
                    formControlName="RoleIdBilling"
                  >
                    <option value="" disabled selected>Select role</option>
                    <option *ngFor="let d of allRoleBilling" [value]="d.roleId">
                      {{ d.roleName }}
                    </option>
                  </select>
                </div>
              </div>
             
              <div class="col-md-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7"
                    >RoleName Sorol</label
                  >
                 <select
                    class="form-select form-select-sm form-select-solid"
                    formControlName="RoleIdSorol"
                    (change)="onRoleSorolChange($event)"
                  >
                    <option value="" disabled selected>Select role</option>
                    <option *ngFor="let d of allPrivilegeSorol" [value]="d.rolename">
                      {{ d.rolename }}
                    </option>
                  </select>
                </div>
              </div>

  <div class="col-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7">Address</label>
                  <textarea
                    class="form-control form-control-sm form-control-solid"
                    rows="2"
                    formControlName="address"
                    placeholder="Enter address"
                  ></textarea>
                </div>
              </div>
 <div class="col-2">
                <div class="fv-row">
                  <label class="form-label fw-bold fs-7">CityCloudPos</label>
                  <textarea
                    class="form-control form-control-sm form-control-solid"
                    rows="2"
                    formControlName="cityCloudPos"
                    placeholder="Enter address"
                  ></textarea>
                </div>
              </div>

            </div>
          </div>

          <!-- Step 2: Project Assignment -->
          <div class="current" *ngIf="currentStep === 2">
            <!-- User Info Summary Card -->
            <div class="card bg-light-info mb-6">
              <div class="card-body py-4">
                <div class="d-flex align-items-center">
                  <div class="symbol symbol-40px symbol-circle me-4">
                    <div class="symbol-label bg-info">
                      <i class="ki-duotone ki-user fs-2 text-white"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-bold fs-6 text-gray-800">
                      {{
                        userForm.get("fullName")?.value ||
                          userForm.get("userName")?.value
                      }}
                    </div>
                    <div class="fs-7 text-muted">
                      {{ userForm.get("email")?.value }}
                    </div>
                  </div>
                
                </div>
              </div>
            </div>

            <!-- Bulk Actions -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div>
                <button
                  type="button"
                  class="btn btn-sm btn-light-success me-2"
                  (click)="selectAllProjects()"
                >
                  <i class="ki-duotone ki-check fs-3"></i>
                  Select All
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-light-danger"
                  (click)="deselectAllProjects()"
                >
                  <i class="ki-duotone ki-cross fs-3"></i>
                  Clear All
                </button>
              </div>
              <div
                class="fs-7 text-muted"
                *ngIf="userForm.get('ProjectListId')?.value"
              >
                Selected IDs:
                <span class="fw-bold">{{
                  userForm.get("ProjectListId")?.value
                }}</span>
              </div>
            </div>

            <!-- Compact Projects Grid -->
            <div class="row g-3" *ngIf="apps.length > 0">
              <div
                class="col-lg-3 col-md-4 col-sm-6"
                *ngFor="let app of apps; let i = index"
              >
                <div
                  class="card card-flush h-100 shadow-sm"
                  [class.border-success]="app.isChecked"
                  [class.bg-light-success]="app.isChecked"
                  style="cursor: pointer"
                  (click)="onProjectCheckChange(app, $event)"
                >
                  <div class="card-body p-4 text-center">
                    <!-- Status and Checkbox -->
                    <div
                      class="d-flex justify-content-between align-items-start mb-3"
                    >
                      <span
                        class="badge badge-sm"
                        [class.badge-success]="app.isActive"
                        [class.badge-danger]="!app.isActive"
                      >
                        {{ app.isActive ? "Active" : "Inactive" }}
                      </span>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [id]="'project_' + app.id"
                          [checked]="app.isChecked"
                          (change)="onProjectCheckChange(app, $event)"
                          (click)="$event.stopPropagation()"
                        />
                      </div>
                    </div>

                    <!-- Project Logo -->
                    <div class="symbol symbol-50px symbol-circle mx-auto mb-3">
                      <img [src]="fileUrl + app.logoUrl" [alt]="app.title" />
                    </div>

                    <!-- Project Title -->
                    <h6 class="fw-bold text-gray-800 mb-2 fs-7">
                      {{ app.title }}
                    </h6>

                    <!-- Navigate URL -->
                    <div
                      class="fs-8 text-muted mb-3 text-truncate"
                      [title]="app.navigateUrl"
                    >
                      {{ app.navigateUrl }}
                    </div>

                    <!-- Selection Indicator -->
                    <div class="mt-auto">
                      <span
                        class="badge badge-sm w-100"
                        [class.badge-success]="app.isChecked"
                        [class.badge-light]="!app.isChecked"
                      >
                        <i
                          class="ki-duotone"
                          [class.ki-check-circle]="app.isChecked"
                          [class.ki-plus-circle]="!app.isChecked"
                          [class.text-white]="app.isChecked"
                          [class.text-muted]="!app.isChecked"
                        ></i>
                        {{ app.isChecked ? "Selected" : "Select" }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- No Projects Message -->
            <div *ngIf="apps.length === 0" class="text-center py-8">
              <i class="ki-duotone ki-folder fs-3x text-muted mb-3"></i>
              <h5 class="text-muted">No Projects Available</h5>
              <p class="text-muted fs-7">
                There are no projects to assign to this user.
              </p>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Footer -->
  <div class="modal-footer">
    <!-- Previous Button -->
    <button
      type="button"
      class="btn btn-light-primary btn-sm me-2"
      *ngIf="currentStep > 1"
      (click)="previousStep()"
    >
      <i class="ki-duotone ki-arrow-left fs-3"></i>
      Previous
    </button>

    <!-- Cancel Button -->
    <button
      type="button"
      class="btn btn-light btn-sm me-2"
      (click)="modal.dismiss('cancel')"
    >
      Cancel
    </button>

    <!-- Next Button -->
    <button
      type="button"
      class="btn btn-primary btn-sm"
      *ngIf="currentStep < totalSteps"
      [disabled]="!isUserFormValid()"
      (click)="nextStep()"
    >
      Next
      <i class="ki-duotone ki-arrow-right fs-3"></i>
    </button>

    <!-- Submit Button -->
    <button
      type="button"
      class="btn btn-success btn-sm"
      *ngIf="currentStep === totalSteps"
      [disabled]="!userForm.valid || isSubmitting"
      (click)="onSubmit(modal)"
    >
      <span *ngIf="!isSubmitting">
        <i class="ki-duotone ki-check fs-3"></i>
        {{ isEditMode ? "Update User" : "Create User" }}
      </span>
      <span *ngIf="isSubmitting">
        <span class="spinner-border spinner-border-sm me-2"></span>
        Processing...
      </span>
    </button>
  </div>
</ng-template>

<swal #noticeSwal [swalOptions]="swalOptions"></swal>
